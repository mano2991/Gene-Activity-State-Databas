<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gene Activity State Database</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 0;
        }
        
        .top-bar {
            background-color: #20558a;
            color: white;
            padding: 10px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .top-bar-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            letter-spacing: -0.5px;
        }
        
        .site-title {
            font-size: 14px;
            font-weight: normal;
            border-left: 1px solid rgba(255, 255, 255, 0.3);
            padding-left: 15px;
        }
        /* Tab Navigation */
        
        .tab-navigation {
            background-color: #1a4570;
            border-bottom: 3px solid #20558a;
        }
        
        .tab-nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 0;
        }
        
        .tab-button {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            padding: 15px 30px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            position: relative;
        }
        
        .tab-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .tab-button.active {
            background-color: #f5f5f5;
            color: #20558a;
            border-bottom: 3px solid #20558a;
            font-weight: bold;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        /* Tab Content */
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* Home Tab Styles */
        
        .hero-section {
            background: white;
            padding: 40px;
            border: 1px solid #d4d4d4;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .hero-section h1 {
            color: #20558a;
            font-size: 36px;
            margin-bottom: 15px;
        }
        
        .hero-section p {
            color: #666;
            font-size: 18px;
            margin-bottom: 30px;
            line-height: 1.8;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 30px;
            border: 1px solid #d4d4d4;
            text-align: center;
        }
        
        .stat-number {
            font-size: 42px;
            font-weight: bold;
            color: #20558a;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 16px;
            color: #666;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .feature-card {
            background: white;
            padding: 25px;
            border: 1px solid #d4d4d4;
        }
        
        .feature-card h3 {
            color: #20558a;
            margin-bottom: 10px;
            font-size: 20px;
        }
        
        .feature-card p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }
        /* Search Tab Styles */
        
        .header {
            background: white;
            padding: 25px;
            border: 1px solid #d4d4d4;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #20558a;
            margin-bottom: 8px;
            font-size: 24px;
            font-weight: bold;
        }
        
        .subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .loading-section {
            background: #e7f3ff;
            padding: 20px;
            border: 1px solid #b3d9ff;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #20558a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        .loading-text {
            color: #20558a;
            font-size: 14px;
            font-weight: 500;
        }
        
        .search-section {
            background: #f8f8f8;
            padding: 20px;
            border: 1px solid #d4d4d4;
            margin-bottom: 20px;
        }
        
        .search-label {
            font-weight: bold;
            margin-bottom: 8px;
            display: block;
            color: #333;
            font-size: 14px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            position: relative;
        }
        
        .input-wrapper {
            flex: 1;
            position: relative;
        }
        
        #geneInput {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #a0a0a0;
            font-size: 14px;
            font-family: Arial, Helvetica, sans-serif;
        }
        
        #geneInput:focus {
            outline: none;
            border-color: #20558a;
            box-shadow: 0 0 3px rgba(32, 85, 138, 0.3);
        }
        
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            background-color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .autocomplete-items div {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }
        
        .autocomplete-items div:hover {
            background-color: #e7f3ff;
        }
        
        .autocomplete-active {
            background-color: #20558a !important;
            color: white !important;
        }
        
        .match-highlight {
            font-weight: bold;
            color: #20558a;
        }
        
        .btn {
            padding: 8px 20px;
            border: 1px solid #a0a0a0;
            font-size: 14px;
            cursor: pointer;
            background: white;
            color: #333;
            font-weight: normal;
        }
        
        .btn:hover {
            background: #e8e8e8;
        }
        
        .btn-search {
            background: #20558a;
            color: white;
            border-color: #20558a;
        }
        
        .btn-search:hover {
            background: #1a4570;
        }
        
        .info-text {
            color: #666;
            font-size: 12px;
            margin-top: 8px;
        }
        
        .data-info {
            background: #d4edda;
            color: #155724;
            padding: 12px 15px;
            border: 1px solid #c3e6cb;
            border-left: 4px solid #28a745;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        #results {
            margin-top: 20px;
        }
        
        .gene-result {
            background: white;
            border: 1px solid #d4d4d4;
            margin-bottom: 20px;
        }
        
        .gene-header {
            background: #f0f0f0;
            padding: 15px 20px;
            border-bottom: 1px solid #d4d4d4;
        }
        
        .gene-name {
            font-size: 18px;
            font-weight: bold;
            color: #20558a;
            margin-bottom: 5px;
        }
        
        .gene-info {
            font-size: 13px;
            color: #666;
        }
        
        .gene-content {
            padding: 20px;
        }
        
        .error-message {
            background: #fff3cd;
            color: #856404;
            padding: 12px 15px;
            border: 1px solid #ffeaa7;
            border-left: 4px solid #ffc107;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .table-container {
            overflow-x: auto;
            border: 1px solid #d4d4d4;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 13px;
        }
        
        th {
            background: #20558a;
            color: white;
            padding: 12px 10px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #1a4570;
        }
        
        td {
            padding: 10px;
            text-align: center;
            border: 1px solid #d4d4d4;
            background: white;
            font-weight: bold;
        }
        
        td.gene-label {
            background: #f0f0f0;
            font-weight: bold;
            text-align: left;
            padding-left: 15px;
            color: #333;
        }
        /* State styling */
        
        .ACTIVE {
            background-color: #28a745;
            color: white;
            font-weight: bold;
        }
        
        .QUIESCENT {
            background-color: #6c757d;
            color: white;
            font-weight: bold;
        }
        
        .PERMISSIVE_ACTIVE {
            background-color: #17a2b8;
            color: white;
            font-weight: bold;
        }
        
        .PERMISSIVE_POISED {
            background-color: #ffc107;
            color: #000;
            font-weight: bold;
        }
        
        .POISED {
            background-color: #fd7e14;
            color: white;
            font-weight: bold;
        }
        
        .PRIMED {
            background-color: #e83e8c;
            color: white;
            font-weight: bold;
        }
        
        .LOW_PRIMED {
            background-color: #6f42c1;
            color: white;
            font-weight: bold;
        }
        
        .legend-section {
            background: white;
            padding: 20px;
            border: 1px solid #d4d4d4;
            margin-top: 20px;
        }
        
        .legend-title {
            font-size: 16px;
            color: #20558a;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            background: #f8f8f8;
            border: 1px solid #e0e0e0;
        }
        
        .legend-color {
            width: 60px;
            height: 30px;
            border: 1px solid #999;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        .legend-label {
            font-size: 13px;
            font-weight: 500;
        }
        /* Heatmap Tab Styles */
        
        .heatmap-controls {
            background: white;
            padding: 20px;
            border: 1px solid #d4d4d4;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .control-group label {
            font-weight: bold;
            min-width: 120px;
        }
        
        .control-group input,
        .control-group select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #a0a0a0;
            font-size: 14px;
        }
        
        .heatmap-container {
            background: white;
            padding: 20px;
            border: 1px solid #d4d4d4;
            overflow: auto;
            max-height: 800px;
        }
        
        #heatmapCanvas {
            border: 1px solid #d4d4d4;
            cursor: crosshair;
        }
        
        .heatmap-info {
            background: #e7f3ff;
            padding: 15px;
            border: 1px solid #b3d9ff;
            margin-top: 20px;
            font-size: 14px;
        }
        /* Network Tab Styles */
        
        .network-placeholder {
            background: white;
            padding: 60px 40px;
            border: 1px solid #d4d4d4;
            text-align: center;
        }
        
        .network-placeholder h2 {
            color: #20558a;
            margin-bottom: 15px;
            font-size: 28px;
        }
        
        .network-placeholder p {
            color: #666;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
            border-top: 1px solid #d4d4d4;
            margin-top: 30px;
            background: white;
        }
        
        @media (max-width: 768px) {
            .tab-nav-content {
                overflow-x: auto;
            }
            .tab-button {
                padding: 12px 20px;
                font-size: 14px;
            }
            .search-box {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
            .stats-grid,
            .features-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="top-bar">
        <div class="top-bar-content">
            <div class="logo">Venkatesh Lab</div>
            <div class="site-title">Gene Activity State Database</div>
        </div>
    </div>

    <div class="tab-navigation">
        <div class="tab-nav-content">
            <button class="tab-button active" onclick="switchTab('home')">üè† Home</button>
            <button class="tab-button" onclick="switchTab('search')">üîç Search</button>
            <button class="tab-button" onclick="switchTab('heatmap')">üó∫Ô∏è Heatmap</button>
            <button class="tab-button" onclick="switchTab('network')">üï∏Ô∏è Network</button>
        </div>
    </div>

    <div class="container">
        <!-- HOME TAB -->
        <div id="home-tab" class="tab-content active">
            <div class="hero-section">
                <h1>Gene Activity State Database</h1>
                <p>Comprehensive database for exploring gene activity states across developmental stages (E10-P0)</p>
                <p style="font-size: 16px; color: #888;">
                    Search individual genes, visualize entire datasets through heatmaps, and explore gene networks
                </p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="statGeneCount">-</div>
                    <div class="stat-label">Total Genes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">8</div>
                    <div class="stat-label">Developmental Stages</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">7</div>
                    <div class="stat-label">Activity States</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statDataPoints">-</div>
                    <div class="stat-label">Total Data Points</div>
                </div>
            </div>

            <div class="features-grid">
                <div class="feature-card">
                    <h3>üîç Gene Search</h3>
                    <p>Search for individual genes or multiple genes at once. Features intelligent autocomplete suggestions as you type, supporting comma-separated queries for batch searches.</p>
                </div>
                <div class="feature-card">
                    <h3>üó∫Ô∏è Interactive Heatmap</h3>
                    <p>Visualize all 23,000+ genes across developmental stages in a comprehensive heatmap. Zoom, pan, and search to explore patterns and trends in gene activity.</p>
                </div>
                <div class="feature-card">
                    <h3>üìä Activity States</h3>
                    <p>Seven distinct activity states: ACTIVE, PERMISSIVE_ACTIVE, PERMISSIVE_POISED, POISED, PRIMED, LOW_PRIMED, and QUIESCENT - each with unique characteristics.</p>
                </div>
                <div class="feature-card">
                    <h3>üï∏Ô∏è Network Analysis</h3>
                    <p>Coming soon: Explore relationships and interactions between genes through network visualization and analysis tools.</p>
                </div>
                <div class="feature-card">
                    <h3>üìà Developmental Stages</h3>
                    <p>Track gene activity across 8 developmental time points from E10 to P0, providing insights into temporal gene expression patterns.</p>
                </div>
                <div class="feature-card">
                    <h3>üíæ Export Data</h3>
                    <p>Export search results and visualizations for further analysis. All data sourced from comprehensive genomic studies.</p>
                </div>
            </div>
        </div>

        <!-- SEARCH TAB -->
        <div id="search-tab" class="tab-content">
            <div class="header">
                <h1>Gene Activity State Search</h1>
                <p class="subtitle">Search and explore gene activity states across developmental stages (E10-P0)</p>
            </div>

            <div id="loadingSection" class="loading-section">
                <div class="spinner"></div>
                <div class="loading-text">Loading gene data from GitHub repository...</div>
            </div>

            <div id="dataInfo"></div>

            <div class="search-section">
                <label class="search-label">Search for Gene Symbol(s):</label>
                <div class="search-box">
                    <div class="input-wrapper">
                        <input type="text" id="geneInput" placeholder="Start typing gene symbol (e.g., Tubb2a)..." oninput="handleInput(event)" onkeydown="handleKeyDown(event)" />
                        <div id="autocomplete-list" class="autocomplete-items"></div>
                    </div>
                    <button class="btn btn-search" onclick="searchGenes()">Search</button>
                    <button class="btn" onclick="clearResults()">Clear</button>
                </div>
                <p class="info-text">Start typing to see suggestions. Press Enter to search, or click on a suggestion.</p>
            </div>

            <div id="results"></div>

            <div class="legend-section">
                <div class="legend-title">Activity State Legend</div>
                <div class="legend-grid">
                    <div class="legend-item">
                        <div class="legend-color ACTIVE">ACTIVE</div>
                        <span class="legend-label">ACTIVE - Highly active state</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color PERMISSIVE_ACTIVE">P_ACTIVE</div>
                        <span class="legend-label">PERMISSIVE_ACTIVE - Permissive active</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color PERMISSIVE_POISED">P_POISED</div>
                        <span class="legend-label">PERMISSIVE_POISED - Permissive poised</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color POISED">POISED</div>
                        <span class="legend-label">POISED - Ready for activation</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color PRIMED">PRIMED</div>
                        <span class="legend-label">PRIMED - Primed for activity</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color LOW_PRIMED">LOW_PRIM</div>
                        <span class="legend-label">LOW_PRIMED - Low primed state</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color QUIESCENT">QUIESC</div>
                        <span class="legend-label">QUIESCENT - Inactive state</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- HEATMAP TAB -->
        <div id="heatmap-tab" class="tab-content">
            <div class="header">
                <h1>Gene Activity Heatmap</h1>
                <p class="subtitle">Visualize all genes across developmental stages</p>
            </div>

            <div class="heatmap-controls">
                <div class="control-group">
                    <label>Search Gene:</label>
                    <input type="text" id="heatmapSearch" placeholder="Enter gene name to highlight and press Enter..." onkeypress="if(event.key==='Enter') searchInHeatmap()">
                    <button class="btn btn-search" onclick="searchInHeatmap()">Find</button>
                </div>
                <div class="control-group">
                    <label>Display Range:</label>
                    <input type="number" id="startGene" placeholder="Start (0)" value="0" min="0">
                    <input type="number" id="endGene" placeholder="End (100)" value="100" min="1">
                    <button class="btn" onclick="renderHeatmap()">Update View</button>
                </div>
                <div class="control-group">
                    <label>Cell Size:</label>
                    <input type="range" id="cellSize" min="80" max="100" value="100" oninput="updateCellSize()">
                    <span id="cellSizeValue">90px</span>
                </div>
            </div>

            <div class="heatmap-info">
                <strong>Instructions:</strong> Use the controls above to navigate through the dataset. Enter start and end indices to view specific gene ranges. Search for a gene to highlight it in the heatmap. Hover over cells to see gene names and states.
            </div>

            <div class="heatmap-container">
                <canvas id="heatmapCanvas"></canvas>
            </div>
        </div>

        <!-- NETWORK TAB -->
        <div id="network-tab" class="tab-content">
            <div class="network-placeholder">
                <h2>üï∏Ô∏è Gene Network Analysis</h2>
                <p>This feature is under development and will be available soon.</p>
                <p style="margin-top: 20px; color: #888;">
                    Future capabilities will include:
                </p>
                <ul style="list-style: none; margin-top: 15px; color: #666;">
                    <li>‚úì Interactive network visualization</li>
                    <li>‚úì Gene-gene interaction mapping</li>
                    <li>‚úì Pathway analysis</li>
                    <li>‚úì Community detection</li>
                    <li>‚úì Export network data</li>
                </ul>
            </div>
        </div>

        <div class="footer">
            Gene Activity State Database | Data visualization tool for developmental stage analysis
        </div>
    </div>

    <script>
        let geneData = [];
        const stages = ['E10', 'E11', 'E12', 'E13', 'E14', 'E15', 'E16', 'P0'];
        let currentFocus = -1;
        let currentTab = 'home';

        const CSV_URL = 'https://raw.githubusercontent.com/mano2991/Gene-Activity-State-Databas/main/Master_RAG_Activity.csv';

        const stateColors = {
            'ACTIVE': '#28a745',
            'QUIESCENT': '#6c757d',
            'PERMISSIVE_ACTIVE': '#17a2b8',
            'PERMISSIVE_POISED': '#ffc107',
            'POISED': '#fd7e14',
            'PRIMED': '#e83e8c',
            'LOW_PRIMED': '#6f42c1'
        };

        // Tab switching
        function switchTab(tabName) {
            currentTab = tabName;

            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            // Initialize heatmap when switching to heatmap tab
            if (tabName === 'heatmap' && geneData.length > 0) {
                setTimeout(() => renderHeatmap(), 100);
            }
        }

        // Load CSV data from GitHub
        async function loadData() {
            try {
                const response = await fetch(CSV_URL);

                if (!response.ok) {
                    throw new Error('Failed to fetch data from GitHub');
                }

                const csvText = await response.text();
                parseCSV(csvText);

                document.getElementById('loadingSection').style.display = 'none';

                document.getElementById('dataInfo').innerHTML =
                    `<div class="data-info">‚úì Data loaded successfully! Database contains ${geneData.length.toLocaleString()} genes. Ready to search.</div>`;

                // Update home page stats
                document.getElementById('statGeneCount').textContent = geneData.length.toLocaleString();
                document.getElementById('statDataPoints').textContent = (geneData.length * 8).toLocaleString();

                document.getElementById('geneInput').focus();

            } catch (error) {
                console.error('Error loading CSV file:', error);
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('dataInfo').innerHTML =
                    '<div class="error-message">‚ö†Ô∏è Error loading data from GitHub. Please check your internet connection and try refreshing the page.</div>';
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',');

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;

                const values = lines[i].split(',');
                const gene = {
                    symbol: values[0].trim(),
                    states: {}
                };

                for (let j = 1; j < headers.length; j++) {
                    gene.states[headers[j].trim()] = values[j] ? values[j].trim() : 'N/A';
                }

                geneData.push(gene);
            }
        }

        // Autocomplete functionality
        function handleInput(event) {
            const input = event.target;
            const fullVal = input.value;
            const cursorPos = input.selectionStart;

            closeAllLists();

            const beforeCursor = fullVal.substring(0, cursorPos);
            const lastCommaIndex = beforeCursor.lastIndexOf(',');
            const currentGene = beforeCursor.substring(lastCommaIndex + 1).trim();

            if (!currentGene || currentGene.length < 1) {
                return false;
            }

            currentFocus = -1;

            const matches = geneData.filter(gene =>
                gene.symbol.toLowerCase().includes(currentGene.toLowerCase())
            ).slice(0, 10);

            if (matches.length === 0) return;

            const listDiv = document.getElementById('autocomplete-list');
            listDiv.innerHTML = '';

            matches.forEach(gene => {
                const div = document.createElement('div');

                const index = gene.symbol.toLowerCase().indexOf(currentGene.toLowerCase());
                const before = gene.symbol.substring(0, index);
                const match = gene.symbol.substring(index, index + currentGene.length);
                const after = gene.symbol.substring(index + currentGene.length);

                div.innerHTML = `${before}<span class="match-highlight">${match}</span>${after}`;
                div.addEventListener('click', function() {
                    const afterCursor = fullVal.substring(cursorPos);
                    const nextCommaIndex = afterCursor.indexOf(',');

                    let newValue;
                    if (lastCommaIndex === -1) {
                        if (nextCommaIndex === -1) {
                            newValue = gene.symbol;
                        } else {
                            newValue = gene.symbol + afterCursor.substring(nextCommaIndex);
                        }
                    } else {
                        const beforeCurrentGene = fullVal.substring(0, lastCommaIndex + 1) + ' ';
                        if (nextCommaIndex === -1) {
                            newValue = beforeCurrentGene + gene.symbol;
                        } else {
                            newValue = beforeCurrentGene + gene.symbol + afterCursor.substring(nextCommaIndex);
                        }
                    }

                    input.value = newValue;

                    const newCursorPos = newValue.indexOf(gene.symbol) + gene.symbol.length;
                    input.setSelectionRange(newCursorPos, newCursorPos);

                    closeAllLists();
                    input.focus();
                });

                listDiv.appendChild(div);
            });
        }

        function handleKeyDown(event) {
            let list = document.getElementById('autocomplete-list');
            let items = list ? list.getElementsByTagName('div') : [];

            if (event.keyCode === 40) {
                currentFocus++;
                addActive(items);
                event.preventDefault();
            } else if (event.keyCode === 38) {
                currentFocus--;
                addActive(items);
                event.preventDefault();
            } else if (event.keyCode === 13) {
                event.preventDefault();
                if (currentFocus > -1 && items[currentFocus]) {
                    items[currentFocus].click();
                } else {
                    searchGenes();
                }
            } else if (event.keyCode === 27) {
                closeAllLists();
            }
        }

        function addActive(items) {
            if (!items || items.length === 0) return false;
            removeActive(items);
            if (currentFocus >= items.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = items.length - 1;
            items[currentFocus].classList.add('autocomplete-active');
            items[currentFocus].scrollIntoView({
                block: 'nearest'
            });
        }

        function removeActive(items) {
            for (let i = 0; i < items.length; i++) {
                items[i].classList.remove('autocomplete-active');
            }
        }

        function closeAllLists() {
            const list = document.getElementById('autocomplete-list');
            list.innerHTML = '';
            currentFocus = -1;
        }

        document.addEventListener('click', function(e) {
            if (e.target !== document.getElementById('geneInput')) {
                closeAllLists();
            }
        });

        function searchGenes() {
            const input = document.getElementById('geneInput').value.trim();
            closeAllLists();

            if (!input) {
                document.getElementById('results').innerHTML =
                    '<div class="error-message">Please enter at least one gene symbol to search.</div>';
                return;
            }

            if (geneData.length === 0) {
                document.getElementById('results').innerHTML =
                    '<div class="error-message">Data is still loading. Please wait a moment and try again.</div>';
                return;
            }

            const geneSymbols = input.split(',').map(g => g.trim()).filter(g => g);

            const resultsDiv = document.getElementById('results');
            let resultsHTML = '';
            let foundCount = 0;
            let notFoundGenes = [];

            geneSymbols.forEach(geneSymbol => {
                const gene = geneData.find(g => g.symbol.toLowerCase() === geneSymbol.toLowerCase());

                if (gene) {
                    foundCount++;
                    resultsHTML += generateGeneTable(gene);
                } else {
                    notFoundGenes.push(geneSymbol);
                }
            });

            if (notFoundGenes.length > 0) {
                resultsHTML = `<div class="error-message">Gene(s) not found in database: <strong>${notFoundGenes.join(', ')}</strong><br>Please verify the gene symbols and try again.</div>` + resultsHTML;
            }

            if (foundCount === 0 && notFoundGenes.length > 0) {
                resultsHTML = '<div class="error-message">No matching genes found. Please check your gene symbols and try again.</div>';
            }

            resultsDiv.innerHTML = resultsHTML;

            if (foundCount > 0) {
                resultsDiv.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }

        function generateGeneTable(gene) {
            let tableHTML = `
                <div class="gene-result">
                    <div class="gene-header">
                        <div class="gene-name">${gene.symbol}</div>
                        <div class="gene-info">Gene Symbol: ${gene.symbol} | Developmental Stages: E10-P0 | Total Stages: 8</div>
                    </div>
                    <div class="gene-content">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th style="text-align: left; padding-left: 15px;">Gene</th>`;

            stages.forEach(stage => {
                tableHTML += `<th>${stage}</th>`;
            });

            tableHTML += `
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="gene-label">${gene.symbol}</td>`;

            stages.forEach(stage => {
                const state = gene.states[stage] || 'N/A';
                tableHTML += `<td class="${state}">${state}</td>`;
            });

            tableHTML += `
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;

            return tableHTML;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('geneInput').value = '';
            closeAllLists();
            document.getElementById('geneInput').focus();
        }

        // Heatmap functions
        let cellSize = 90;
        let highlightedGeneIndex = -1;

        function updateCellSize() {
            cellSize = parseInt(document.getElementById('cellSize').value);
            document.getElementById('cellSizeValue').textContent = cellSize + 'px';
            if (currentTab === 'heatmap') {
                renderHeatmap();
            }
        }

        function renderHeatmap() {
            if (geneData.length === 0) return;

            const canvas = document.getElementById('heatmapCanvas');
            const ctx = canvas.getContext('2d');

            const startIdx = parseInt(document.getElementById('startGene').value) || 0;
            let endIdx = parseInt(document.getElementById('endGene').value) || 100;

            if (endIdx > geneData.length) endIdx = geneData.length;
            if (startIdx >= endIdx) {
                alert('Start index must be less than end index');
                return;
            }

            const genesSubset = geneData.slice(startIdx, endIdx);
            const numGenes = genesSubset.length;
            const numStages = stages.length;

            // Set canvas size
            const labelWidth = 150;
            canvas.width = labelWidth + (numStages * cellSize);
            canvas.height = numGenes * cellSize + 30;

            // Clear canvas
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw headers
            ctx.font = 'bold 24px Arial';
            ctx.fillStyle = '#20558a';
            ctx.textAlign = 'center';
            stages.forEach((stage, i) => {
                ctx.fillText(stage, labelWidth + (i * cellSize) + cellSize / 2, 20);
            });

            // Draw heatmap
            genesSubset.forEach((gene, geneIdx) => {
                const y = 30 + (geneIdx * cellSize);

                // Draw gene label
                // Draw gene label
                ctx.font = highlightedGeneIndex === (startIdx + geneIdx) ? 'bold 24px Arial' : '28px Arial';
                ctx.fillStyle = highlightedGeneIndex === (startIdx + geneIdx) ? '#e83e8c' : '#333';
                ctx.textAlign = 'left';
                const label = gene.symbol.length > 18 ? gene.symbol.substring(0, 18) + '...' : gene.symbol;
                ctx.fillText(label, 5, y + cellSize / 2 + 4);

                // Draw cells
                stages.forEach((stage, stageIdx) => {
                    const x = labelWidth + (stageIdx * cellSize);
                    const state = gene.states[stage];

                    ctx.fillStyle = stateColors[state] || '#cccccc';
                    ctx.fillRect(x, y, cellSize - 1, cellSize - 1);

                    // Highlight if this is the searched gene
                    if (highlightedGeneIndex === (startIdx + geneIdx)) {
                        ctx.strokeStyle = '#e83e8c';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(x, y, cellSize - 1, cellSize - 1);
                    }
                });
            });

            // Add tooltip on hover
            canvas.onmousemove = function(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                if (x > labelWidth && y > 30) {
                    const geneIdx = Math.floor((y - 30) / cellSize);
                    const stageIdx = Math.floor((x - labelWidth) / cellSize);

                    if (geneIdx >= 0 && geneIdx < numGenes && stageIdx >= 0 && stageIdx < numStages) {
                        const gene = genesSubset[geneIdx];
                        const stage = stages[stageIdx];
                        const state = gene.states[stage];
                        canvas.title = `${gene.symbol} - ${stage}: ${state}`;
                    }
                }
            };
        }

        function searchInHeatmap() {
            const searchTerm = document.getElementById('heatmapSearch').value.trim().toLowerCase();
            if (!searchTerm) {
                highlightedGeneIndex = -1;
                renderHeatmap();
                return;
            }

            const foundIndex = geneData.findIndex(gene =>
                gene.symbol.toLowerCase() === searchTerm
            );

            if (foundIndex !== -1) {
                highlightedGeneIndex = foundIndex;

                // Update range to show the gene
                const startIdx = Math.max(0, foundIndex - 50);
                const endIdx = Math.min(geneData.length, foundIndex + 50);

                document.getElementById('startGene').value = startIdx;
                document.getElementById('endGene').value = endIdx;

                renderHeatmap();
                // Scroll the heatmap container to top
                document.querySelector('.heatmap-container').scrollTop = 0;
                document.getElementById('heatmapSearch').style.backgroundColor = '#d4edda';
                setTimeout(() => {
                    document.getElementById('heatmapSearch').style.backgroundColor = '';
                }, 1000);
            } else {
                alert('Gene not found: ' + searchTerm);
                highlightedGeneIndex = -1;
            }
        }

        // Load data when page loads
        window.addEventListener('load', loadData);
    </script>
</body>

</html>