<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gene Activity State Database</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="gene_details.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 0;
        }
        
        .top-bar {
            background-color: #20558a;
            color: white;
            padding: 10px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .top-bar-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            letter-spacing: -0.5px;
        }
        
        .site-title {
            font-size: 14px;
            font-weight: normal;
            border-left: 1px solid rgba(255, 255, 255, 0.3);
            padding-left: 15px;
        }
        /* Tab Navigation */
        
        .tab-navigation {
            background-color: #1a4570;
            border-bottom: 3px solid #20558a;
        }
        
        .tab-nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 0;
        }
        
        .tab-button {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            padding: 15px 30px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            position: relative;
        }
        
        .tab-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .tab-button.active {
            background-color: #f5f5f5;
            color: #20558a;
            border-bottom: 3px solid #20558a;
            font-weight: bold;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        /* Tab Content */
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* Home Tab Styles */
        
        .hero-section {
            background: white;
            padding: 40px;
            border: 1px solid #d4d4d4;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .hero-section h1 {
            color: #20558a;
            font-size: 36px;
            margin-bottom: 15px;
        }
        
        .hero-section p {
            color: #666;
            font-size: 18px;
            margin-bottom: 30px;
            line-height: 1.8;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 30px;
            border: 1px solid #d4d4d4;
            text-align: center;
        }
        
        .stat-number {
            font-size: 42px;
            font-weight: bold;
            color: #20558a;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 16px;
            color: #666;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .feature-card {
            background: white;
            padding: 25px;
            border: 1px solid #d4d4d4;
        }
        
        .feature-card h3 {
            color: #20558a;
            margin-bottom: 10px;
            font-size: 20px;
        }
        
        .feature-card p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }
        /* Search Tab Styles */
        
        .header {
            background: white;
            padding: 25px;
            border: 1px solid #d4d4d4;
            margin-bottom: 20px;
        }
        
        h1 {
            color: #20558a;
            margin-bottom: 8px;
            font-size: 24px;
            font-weight: bold;
        }
        
        .subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .loading-section {
            background: #e7f3ff;
            padding: 20px;
            border: 1px solid #b3d9ff;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #20558a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        .loading-text {
            color: #20558a;
            font-size: 14px;
            font-weight: 500;
        }
        
        .search-section {
            background: #f8f8f8;
            padding: 20px;
            border: 1px solid #d4d4d4;
            margin-bottom: 20px;
        }
        
        .search-label {
            font-weight: bold;
            margin-bottom: 8px;
            display: block;
            color: #333;
            font-size: 14px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            position: relative;
        }
        
        .input-wrapper {
            flex: 1;
            position: relative;
        }
        
        #geneInput {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #a0a0a0;
            font-size: 14px;
            font-family: Arial, Helvetica, sans-serif;
        }
        
        #geneInput:focus {
            outline: none;
            border-color: #20558a;
            box-shadow: 0 0 3px rgba(32, 85, 138, 0.3);
        }
        
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            background-color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .autocomplete-items div {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }
        
        .autocomplete-items div:hover {
            background-color: #e7f3ff;
        }
        
        .autocomplete-active {
            background-color: #20558a !important;
            color: white !important;
        }
        
        .match-highlight {
            font-weight: bold;
            color: #20558a;
        }
        
        .btn {
            padding: 8px 20px;
            border: 1px solid #a0a0a0;
            font-size: 14px;
            cursor: pointer;
            background: white;
            color: #333;
            font-weight: normal;
        }
        
        .btn:hover {
            background: #e8e8e8;
        }
        
        .btn-search {
            background: #20558a;
            color: white;
            border-color: #20558a;
        }
        
        .btn-search:hover {
            background: #1a4570;
        }
        
        .info-text {
            color: #666;
            font-size: 12px;
            margin-top: 8px;
        }
        
        .data-info {
            background: #d4edda;
            color: #155724;
            padding: 12px 15px;
            border: 1px solid #c3e6cb;
            border-left: 4px solid #28a745;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        #results {
            margin-top: 20px;
        }
        
        .gene-result {
            background: white;
            border: 1px solid #d4d4d4;
            margin-bottom: 20px;
        }
        
        .gene-header {
            background: #f0f0f0;
            padding: 15px 20px;
            border-bottom: 1px solid #d4d4d4;
        }
        
        .gene-name {
            font-size: 18px;
            font-weight: bold;
            color: #20558a;
            margin-bottom: 5px;
        }
        
        .gene-info {
            font-size: 13px;
            color: #666;
        }
        
        .gene-content {
            padding: 20px;
        }
        
        .error-message {
            background: #fff3cd;
            color: #856404;
            padding: 12px 15px;
            border: 1px solid #ffeaa7;
            border-left: 4px solid #ffc107;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .table-container {
            overflow-x: auto;
            border: 1px solid #d4d4d4;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 13px;
        }
        
        th {
            background: #20558a;
            color: white;
            padding: 12px 10px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #1a4570;
        }
        
        td {
            padding: 10px;
            text-align: center;
            border: 1px solid #d4d4d4;
            background: white;
            font-weight: bold;
        }
        
        td.gene-label {
            background: #f0f0f0;
            font-weight: bold;
            text-align: left;
            padding-left: 15px;
            color: #333;
        }
        /* State styling */
        
        .ACTIVE {
            background-color: #28a745;
            color: white;
            font-weight: bold;
        }
        
        .QUIESCENT {
            background-color: #6c757d;
            color: white;
            font-weight: bold;
        }
        
        .REFRACTORY {
            background-color: #dc3545;
            color: white;
            font-weight: bold;
        }

        .TRANSCRIBE {
            background-color: #17a2b8;
            color: white;
            font-weight: bold;
        }
        
        .POISED {
            background-color: #fd7e14;
            color: white;
            font-weight: bold;
        }
        
        .PRIMED {
            background-color: #e83e8c;
            color: white;
            font-weight: bold;
        }
        
        
        .legend-section {
            background: white;
            padding: 20px;
            border: 1px solid #d4d4d4;
            margin-top: 20px;
        }
        
        .legend-title {
            font-size: 16px;
            color: #20558a;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            background: #f8f8f8;
            border: 1px solid #e0e0e0;
        }
        
        .legend-color {
            width: 60px;
            height: 30px;
            border: 1px solid #999;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        .legend-label {
            font-size: 13px;
            font-weight: 500;
        }
        /* Heatmap Tab Styles */
        
        .heatmap-controls {
            background: white;
            padding: 20px;
            border: 1px solid #d4d4d4;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .control-group label {
            font-weight: bold;
            min-width: 120px;
        }
        
        .control-group input,
        .control-group select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #a0a0a0;
            font-size: 14px;
        }
        
        .heatmap-container {
            background: white;
            padding: 20px;
            border: 1px solid #d4d4d4;
            overflow: auto;
            max-height: 800px;
        }
        
        #heatmapCanvas {
            border: 1px solid #d4d4d4;
            cursor: crosshair;
        }
        
        .heatmap-info {
            background: #e7f3ff;
            padding: 15px;
            border: 1px solid #b3d9ff;
            margin-top: 20px;
            font-size: 14px;
        }
        /* Toggle Switch Styles */
        .toggle-group {
            margin-bottom: 15px;
        }

        .toggle-group-label {
            font-weight: bold;
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .toggle-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .toggle-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border: 2px solid #d4d4d4;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            user-select: none;
            transition: all 0.2s;
            background: #f0f0f0;
            color: #666;
        }

        .toggle-chip.active {
            background: #20558a;
            color: white;
            border-color: #20558a;
        }

        .toggle-chip.active .toggle-dot {
            background: white;
        }

        .toggle-chip .toggle-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #999;
            transition: background 0.2s;
        }

        .toggle-chip.state-chip.active {
            border-color: var(--state-color);
            background: var(--state-color);
        }

        .filter-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .filter-actions .btn {
            padding: 5px 12px;
            font-size: 12px;
        }

        .filter-summary {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        /* Export Button */
        .export-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            margin: 10px 5px 10px 0;
        }

        .export-btn:hover {
            background: #218838;
        }

        /* External Links */
        .external-links {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .ext-link {
            display: inline-block;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 12px;
            text-decoration: none;
            color: white;
            transition: opacity 0.2s;
        }

        .ext-link:hover {
            opacity: 0.8;
        }

        .ext-link.genecards { background: #2196F3; }
        .ext-link.ncbi { background: #1565C0; }
        .ext-link.ensembl { background: #6A1B9A; }
        .ext-link.ucsc { background: #E65100; }

        /* Bookmark */
        .bookmark-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            padding: 0 8px;
            vertical-align: middle;
            transition: transform 0.2s;
        }

        .bookmark-btn:hover {
            transform: scale(1.2);
        }

        .bookmarks-bar {
            background: white;
            padding: 15px 20px;
            border: 1px solid #d4d4d4;
            margin-bottom: 15px;
        }

        .bookmarks-bar-title {
            font-size: 14px;
            font-weight: bold;
            color: #20558a;
            margin-bottom: 8px;
        }

        .bookmark-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }

        .bookmark-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 14px;
            font-size: 12px;
            font-weight: 600;
            color: #20558a;
            cursor: pointer;
        }

        .bookmark-chip:hover {
            background: #20558a;
            color: white;
        }

        .bookmark-chip .remove-bookmark {
            font-size: 14px;
            margin-left: 2px;
            cursor: pointer;
        }

        /* Transition Search */
        .transition-section {
            background: #f8f8f8;
            padding: 20px;
            border: 1px solid #d4d4d4;
            margin-bottom: 20px;
        }

        .transition-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-end;
            margin-top: 10px;
        }

        .transition-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .transition-field label {
            font-size: 12px;
            font-weight: 600;
            color: #555;
        }

        .transition-field select {
            padding: 7px 10px;
            border: 1px solid #a0a0a0;
            font-size: 13px;
            min-width: 140px;
        }

        .transition-arrow {
            font-size: 24px;
            color: #20558a;
            padding-bottom: 4px;
            font-weight: bold;
        }

        /* Statistics Tab */
        .stats-section {
            background: white;
            padding: 25px;
            border: 1px solid #d4d4d4;
            margin-bottom: 20px;
        }

        .stats-section h2 {
            color: #20558a;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .chart-container {
            width: 100%;
            overflow-x: auto;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .comparison-grid select {
            padding: 8px 12px;
            border: 1px solid #a0a0a0;
            font-size: 14px;
            width: 100%;
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 15px;
        }

        .matrix-table th {
            background: #20558a;
            color: white;
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #1a4570;
            font-size: 12px;
        }

        .matrix-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #d4d4d4;
            font-weight: 600;
        }

        .matrix-table td.row-header {
            background: #f0f0f0;
            text-align: left;
            font-weight: bold;
            color: #333;
        }

        .matrix-cell-high { background: #c8e6c9; }
        .matrix-cell-med { background: #fff9c4; }
        .matrix-cell-low { background: #ffecb3; }
        .matrix-cell-zero { background: #f5f5f5; color: #ccc; }

        .share-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: #6c757d;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-left: 5px;
        }

        .share-btn:hover { background: #5a6268; }

        /* Network Tab Styles */
        
        .network-placeholder {
            background: white;
            padding: 60px 40px;
            border: 1px solid #d4d4d4;
            text-align: center;
        }
        
        .network-placeholder h2 {
            color: #20558a;
            margin-bottom: 15px;
            font-size: 28px;
        }
        
        .network-placeholder p {
            color: #666;
            font-size: 16px;
            margin-bottom: 10px;
        }
        /* Network Plot Styles */
        
        .network-container {
            width: 100%;
            height: 800px;
            background: white;
            border: 1px solid #d4d4d4;
            border-top: none;
            overflow: auto;
            /* Allow scrolling */
            position: relative;
        }
        
        .node circle {
            fill: #fff;
            stroke: #20558a;
            stroke-width: 2px;
        }
        
        .node rect {
            fill: #20558a;
            stroke: #fff;
            stroke-width: 2px;
            rx: 10;
            ry: 10;
        }
        
        .node text {
            font: 12px sans-serif;
            fill: #333;
        }
        
        .node--internal text {
            text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
        }
        
        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
        }
        
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            font: 12px sans-serif;
            background: #20558a;
            color: white;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
            border-top: 1px solid #d4d4d4;
            margin-top: 30px;
            background: white;
        }
        
        @media (max-width: 768px) {
            .tab-nav-content {
                overflow-x: auto;
            }
            .tab-button {
                padding: 12px 20px;
                font-size: 14px;
            }
            .search-box {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
            .stats-grid,
            .features-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="top-bar">
        <div class="top-bar-content">
            <div class="logo"><a href="https://venkateshlab.science/" target="_blank" style="color: white; text-decoration: none;">Venkatesh Lab</a></div>
            <div class="site-title">Gene Activity State Database</div>
        </div>
    </div>

    <div class="tab-navigation">
        <div class="tab-nav-content">
            <button class="tab-button active" onclick="switchTab('home')">üè† Home</button>
            <button class="tab-button" onclick="switchTab('search')">üîç Search</button>
            <button class="tab-button" onclick="switchTab('heatmap')">üó∫Ô∏è Heatmap</button>
            <button class="tab-button" onclick="switchTab('network')">üï∏Ô∏è Network</button>
            <button class="tab-button" onclick="switchTab('stats')">üìä Statistics</button>
        </div>
    </div>

    <div class="container">
        <!-- HOME TAB -->
        <div id="home-tab" class="tab-content active">
            <div class="hero-section">
                <h1>Gene Activity State Database</h1>
                <p>Comprehensive database for exploring gene activity states across developmental stages (E10-P0)</p>
                <p style="font-size: 16px; color: #888;">
                    Search individual genes, visualize entire datasets through heatmaps, and explore gene networks
                </p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="statGeneCount">-</div>
                    <div class="stat-label">Total Genes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">8</div>
                    <div class="stat-label">Developmental Stages</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">6</div>
                    <div class="stat-label">Activity States</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statDataPoints">-</div>
                    <div class="stat-label">Total Data Points</div>
                </div>
            </div>

            <div class="features-grid">
                <div class="feature-card">
                    <h3>üîç Gene Search</h3>
                    <p>Search for individual genes or multiple genes at once. Features intelligent autocomplete suggestions and batch search capabilities.</p>
                </div>
                <div class="feature-card">
                    <h3>üó∫Ô∏è Interactive Heatmap</h3>
                    <p>Visualize 23,000+ genes across developmental stages. Filter by gene name to see specific patterns and export high-resolution views.</p>
                </div>
                <div class="feature-card">
                    <h3>üï∏Ô∏è Network Analysis</h3>
                    <p>Visualize hierarchical relationships between genes, developmental stages, and histone marks. Includes 300 DPI export for publications.</p>
                </div>
                <div class="feature-card">
                    <h3>üîÆ Adult State Prediction</h3>
                    <p>Utilizes Markov Chain statistical modeling to predict the likely activity state of genes in the Adult stage based on their E10-P0 trajectory.</p>
                </div>
            </div>
        </div>

        <!-- SEARCH TAB -->
        <div id="search-tab" class="tab-content">
            <div class="header">
                <h1>Gene Activity State Search</h1>
                <p class="subtitle">Search and explore gene activity states across developmental stages (E10-P0)</p>
            </div>

            <div id="loadingSection" class="loading-section">
                <div class="spinner"></div>
                <div class="loading-text">Loading gene data from GitHub repository...</div>
            </div>

            <div id="dataInfo"></div>

            <!-- Bookmarks Bar -->
            <div class="bookmarks-bar" id="bookmarksBar" style="display:none;">
                <div class="bookmarks-bar-title">Bookmarked Genes</div>
                <div class="bookmark-chips" id="bookmarkChips"></div>
                <button class="btn" onclick="searchBookmarkedGenes()" style="font-size:12px; padding:4px 10px;">Search All Bookmarks</button>
                <button class="export-btn" onclick="exportBookmarks()" style="font-size:11px; padding:4px 10px; margin:0 0 0 5px;">Export Bookmarks CSV</button>
                <button class="btn" onclick="clearBookmarks()" style="font-size:12px; padding:4px 10px; margin-left:5px; color:#dc3545; border-color:#dc3545;">Clear All</button>
            </div>

            <div class="search-section">
                <label class="search-label">Search for Gene Symbol(s):</label>
                <div class="search-box">
                    <div class="input-wrapper">
                        <input type="text" id="geneInput" placeholder="Start typing gene symbol (e.g., Tubb2a)..." oninput="handleInput(event)" onkeydown="handleKeyDown(event)" />
                        <div id="autocomplete-list" class="autocomplete-items"></div>
                    </div>
                    <button class="btn btn-search" onclick="searchGenes()">Search</button>
                    <button class="btn" onclick="clearResults()">Clear</button>
                    <button class="share-btn" onclick="copyShareLink()" title="Copy shareable link">Share Link</button>
                </div>
                <p class="info-text">Start typing to see suggestions. Press Enter to search, or click on a suggestion.</p>
            </div>

            <!-- Transition Search -->
            <div class="transition-section">
                <label class="search-label">State Transition Search</label>
                <p class="info-text" style="margin-top:0; margin-bottom:10px;">Find genes that transition between specific states across developmental stages.</p>
                <div class="transition-row">
                    <div class="transition-field">
                        <label>From Stage</label>
                        <select id="transFromStage"></select>
                    </div>
                    <div class="transition-field">
                        <label>From State</label>
                        <select id="transFromState"></select>
                    </div>
                    <div class="transition-arrow">&#8594;</div>
                    <div class="transition-field">
                        <label>To Stage</label>
                        <select id="transToStage"></select>
                    </div>
                    <div class="transition-field">
                        <label>To State</label>
                        <select id="transToState"></select>
                    </div>
                    <button class="btn btn-search" onclick="searchTransition()">Find Genes</button>
                </div>
                <div id="transitionResults" style="margin-top:10px; font-size:13px; color:#666;"></div>
            </div>

            <div id="results"></div>
            <div style="margin-bottom:10px;">
                <button class="export-btn" id="exportSearchBtn" style="display:none;" onclick="exportSearchResults()">Export Search Results CSV</button>
            </div>

            <div class="legend-section">
                <div class="legend-title">Activity State Legend</div>
                <div class="legend-grid">
                    <div class="legend-item">
                        <div class="legend-color QUIESCENT">QUIESC</div>
                        <span class="legend-label">QUIESCENT - Inactive state</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color REFRACTORY">REFRAC</div>
                        <span class="legend-label">REFRACTORY - Refractory state</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color ACTIVE">ACTIVE</div>
                        <span class="legend-label">ACTIVE - Highly active state</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color PRIMED">PRIMED</div>
                        <span class="legend-label">PRIMED - Primed for activity</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color TRANSCRIBE">TRANSC</div>
                        <span class="legend-label">TRANSCRIBE - Transcribing state</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color POISED">POISED</div>
                        <span class="legend-label">POISED - Ready for activation</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- HEATMAP TAB -->
        <div id="heatmap-tab" class="tab-content">
            <div class="header">
                <h1>Gene Activity Heatmap</h1>
                <p class="subtitle">Visualize all genes across developmental stages</p>
            </div>

            <div class="heatmap-controls">
                <div class="control-group">
                    <label>Search Gene:</label>
                    <div class="input-wrapper" style="flex: 1;">
                        <input type="text" id="heatmapSearch" placeholder="Enter gene name(s)..." style="width: 100%;" oninput="handleHeatmapInput(event)" onkeydown="handleHeatmapKeyDown(event)">
                        <div id="heatmap-autocomplete-list" class="autocomplete-items"></div>
                    </div>
                    <button class="btn btn-search" onclick="searchInHeatmap()">Find</button>
                </div>

                <div class="toggle-group">
                    <span class="toggle-group-label">Filter by Stage:</span>
                    <div class="toggle-row" id="stageToggles"></div>
                </div>

                <div class="toggle-group">
                    <span class="toggle-group-label">Filter by State:</span>
                    <div class="toggle-row" id="stateToggles"></div>
                    <div class="filter-actions">
                        <button class="btn" onclick="selectAllToggles('stage')">All Stages</button>
                        <button class="btn" onclick="selectAllToggles('state')">All States</button>
                        <button class="btn" onclick="clearAllToggles()">Clear Filters</button>
                        <button class="btn btn-search" onclick="applyHeatmapFilters()">Apply Filters</button>
                    </div>
                    <div class="filter-summary" id="filterSummary"></div>
                </div>

                <div class="control-group">
                    <label>Display Range:</label>
                    <input type="number" id="startGene" placeholder="Start (0)" value="0" min="0">
                    <input type="number" id="endGene" placeholder="End (100)" value="100" min="1">
                    <button class="btn" onclick="renderHeatmap()">Update View</button>
                </div>
                <div class="control-group">
                    <label>Cell Size:</label>
                    <input type="range" id="cellSize" min="80" max="100" value="100" oninput="updateCellSize()">
                    <span id="cellSizeValue">90px</span>
                </div>
            </div>

            <div class="heatmap-info">
                <strong>Instructions:</strong> Use the controls above to navigate through the dataset. Enter start and end indices to view specific gene ranges. Search for a gene to highlight it in the heatmap. Hover over cells to see gene names and states.
                <br><button class="export-btn" onclick="exportHeatmapCSV()" style="margin-top:10px;">Export Filtered Data CSV</button>
            </div>

            <div class="legend-section">
                <div class="legend-title">Activity State Legend</div>
                <div class="legend-grid">
                    <div class="legend-item">
                        <div class="legend-color QUIESCENT">QUIESC</div>
                        <span class="legend-label">QUIESCENT - Inactive state</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color REFRACTORY">REFRAC</div>
                        <span class="legend-label">REFRACTORY - Refractory state</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color ACTIVE">ACTIVE</div>
                        <span class="legend-label">ACTIVE - Highly active state</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color PRIMED">PRIMED</div>
                        <span class="legend-label">PRIMED - Primed for activity</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color TRANSCRIBE">TRANSC</div>
                        <span class="legend-label">TRANSCRIBE - Transcribing state</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color POISED">POISED</div>
                        <span class="legend-label">POISED - Ready for activation</span>
                    </div>
                </div>
            </div>

            <div class="heatmap-container">
                <canvas id="heatmapCanvas"></canvas>
            </div>
        </div>

        <!-- NETWORK TAB -->
        <div id="network-tab" class="tab-content">
            <div class="header">
                <h1>Gene Network Analysis</h1>
                <p class="subtitle">Explore hierarchical relationships between genes, stages, and histone marks</p>
            </div>

            <div class="search-section">
                <label class="search-label">Visualize Network for Gene:</label>
                <div class="search-box">
                    <div class="input-wrapper" style="flex: 1;">
                        <input type="text" id="networkSearchInput" placeholder="Enter gene symbol..." style="width: 100%; padding: 8px 12px; border: 1px solid #a0a0a0; font-size: 14px;" oninput="handleNetworkInput(event)" onkeydown="handleNetworkKeyDown(event)">
                        <div id="network-autocomplete-list" class="autocomplete-items"></div>
                    </div>
                    <button class="btn btn-search" onclick="searchNetworkTab()">Visualize</button>
                </div>
            </div>

            <div id="network-main-container" class="network-container" style="height: 1200px; border: 1px solid #d4d4d4;">
                <div style="padding: 40px; text-align: center; color: #666;">
                    Search for a gene above to view its hierarchical network plot.
                </div>
            </div>
        </div>

        <!-- STATISTICS TAB -->
        <div id="stats-tab" class="tab-content">
            <div class="header">
                <h1>Dataset Statistics</h1>
                <p class="subtitle">Overview of gene activity state distributions and stage-to-stage transitions</p>
            </div>

            <div class="stats-section">
                <h2>State Distribution per Stage</h2>
                <p style="font-size:13px; color:#666; margin-bottom:15px;">Number of genes in each activity state at every developmental stage.</p>
                <div class="chart-container" id="distributionChart"></div>
            </div>

            <div class="stats-section">
                <h2>Stage Comparison - Transition Matrix</h2>
                <p style="font-size:13px; color:#666; margin-bottom:15px;">Select two stages to see how many genes transitioned between each state.</p>
                <div class="comparison-grid">
                    <div class="transition-field">
                        <label>From Stage:</label>
                        <select id="compareStageA" onchange="renderComparisonMatrix()"></select>
                    </div>
                    <div class="transition-field">
                        <label>To Stage:</label>
                        <select id="compareStageB" onchange="renderComparisonMatrix()"></select>
                    </div>
                </div>
                <div id="comparisonMatrixContainer"></div>
            </div>
        </div>

        <div class="footer">
            Gene Activity State Database | Data visualization tool for developmental stage analysis<br> Released under the MIT License<br> Developed by <a href="https://github.com/mano2991" target="_blank" style="color: #20558a; text-decoration: none; font-weight: bold;">Manoj</a>
        </div>
    </div>

    <script>
        let geneData = [];
        let currentHeatmapData = [];
        const stages = ['E10', 'E11', 'E12', 'E13', 'E14', 'E15', 'E16', 'P0'];
        const allStates = ['QUIESCENT', 'REFRACTORY', 'ACTIVE', 'PRIMED', 'TRANSCRIBE', 'POISED'];
        let activeStages = new Set(stages);
        let activeStatesFilter = new Set(allStates);
        let currentFocus = -1;
        let currentTab = 'home';
        let lastSearchResults = [];

        const CSV_URL = 'https://raw.githubusercontent.com/mano2991/Gene-Activity-State-Databas/main/Master_RAG_Activity.csv';

        const stateColors = {
            'QUIESCENT': '#6c757d',
            'REFRACTORY': '#dc3545',
            'ACTIVE': '#28a745',
            'PRIMED': '#e83e8c',
            'TRANSCRIBE': '#17a2b8',
            'POISED': '#fd7e14'
        };

        // Tab switching
        function switchTab(tabName) {
            currentTab = tabName;

            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            // Initialize views when switching tabs
            if (tabName === 'heatmap' && geneData.length > 0) {
                setTimeout(() => renderHeatmap(), 100);
            }
            if (tabName === 'stats' && geneData.length > 0) {
                setTimeout(() => {
                    renderDistributionChart();
                    renderComparisonMatrix();
                }, 100);
            }
        }

        // Load CSV data from GitHub
        async function loadData() {
            try {
                const response = await fetch(CSV_URL);

                if (!response.ok) {
                    throw new Error('Failed to fetch data from GitHub');
                }

                const csvText = await response.text();
                parseCSV(csvText);
                currentHeatmapData = geneData;

                // Train prediction model on loaded data
                trainPredictionModel();

                document.getElementById('loadingSection').style.display = 'none';

                document.getElementById('dataInfo').innerHTML =
                    `<div class="data-info">‚úì Data loaded successfully! Database contains ${geneData.length.toLocaleString()} genes. Ready to search.</div>`;

                // Update home page stats
                document.getElementById('statGeneCount').textContent = geneData.length.toLocaleString();
                document.getElementById('statDataPoints').textContent = (geneData.length * 8).toLocaleString();

                initToggles();
                initTransitionDropdowns();
                initStatsTab();
                renderBookmarksBar();
                checkURLParams();
                document.getElementById('geneInput').focus();

            } catch (error) {
                console.error('Error loading CSV file:', error);
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('dataInfo').innerHTML =
                    '<div class="error-message">‚ö†Ô∏è Error loading data from GitHub. Please check your internet connection and try refreshing the page.</div>';
            }
        }

        // --- Prediction Logic ---
        let transitionProbs = {};

        function trainPredictionModel() {
            let transitions = {};

            // Iterate all genes to learn E10->P0 patterns
            geneData.forEach(gene => {
                for (let i = 0; i < stages.length - 1; i++) {
                    let curr = gene.states[stages[i]];
                    let next = gene.states[stages[i + 1]];

                    if (!curr || !next || curr === 'N/A' || next === 'N/A') continue;

                    if (!transitions[curr]) transitions[curr] = {};
                    if (!transitions[curr][next]) transitions[curr][next] = 0;
                    transitions[curr][next]++;
                }
            });

            // Calculate probabilities
            for (let state in transitions) {
                let total = 0;
                for (let next in transitions[state]) total += transitions[state][next];

                transitionProbs[state] = {};
                for (let next in transitions[state]) {
                    transitionProbs[state][next] = transitions[state][next] / total;
                }
            }
            console.log("Prediction model trained locally.");
        }

        function predictAdult(p0State) {
            if (!p0State || p0State === 'N/A' || !transitionProbs[p0State]) return p0State;

            let bestNext = p0State;
            let maxProb = -1;

            for (let next in transitionProbs[p0State]) {
                if (transitionProbs[p0State][next] > maxProb) {
                    maxProb = transitionProbs[p0State][next];
                    bestNext = next;
                }
            }
            return bestNext;
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',');

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;

                const values = lines[i].split(',');
                const gene = {
                    symbol: values[0].trim(),
                    states: {}
                };

                for (let j = 1; j < headers.length; j++) {
                    gene.states[headers[j].trim()] = values[j] ? values[j].trim() : 'N/A';
                }

                geneData.push(gene);
            }
        }

        // Autocomplete functionality
        function handleInput(event) {
            const input = event.target;
            const fullVal = input.value;
            const cursorPos = input.selectionStart;

            closeAllLists();

            const beforeCursor = fullVal.substring(0, cursorPos);
            const lastCommaIndex = beforeCursor.lastIndexOf(',');
            const currentGene = beforeCursor.substring(lastCommaIndex + 1).trim();

            if (!currentGene || currentGene.length < 1) {
                return false;
            }

            currentFocus = -1;

            const term = currentGene.toLowerCase();
            let matches = geneData.filter(gene =>
                gene.symbol.toLowerCase().includes(term)
            );

            // Sort: Exact -> StartsWith -> Alphabetical
            matches.sort((a, b) => {
                const aSym = a.symbol.toLowerCase();
                const bSym = b.symbol.toLowerCase();

                // 1. Exact match first
                if (aSym === term && bSym !== term) return -1;
                if (bSym === term && aSym !== term) return 1;

                // 2. Starts with second
                const aStart = aSym.startsWith(term);
                const bStart = bSym.startsWith(term);
                if (aStart && !bStart) return -1;
                if (!aStart && bStart) return 1;

                // 3. Alphabetical
                return aSym.localeCompare(bSym);
            });

            matches = matches.slice(0, 10);

            if (matches.length === 0) return;

            const listDiv = document.getElementById('autocomplete-list');
            listDiv.innerHTML = '';

            matches.forEach(gene => {
                const div = document.createElement('div');

                const index = gene.symbol.toLowerCase().indexOf(currentGene.toLowerCase());
                const before = gene.symbol.substring(0, index);
                const match = gene.symbol.substring(index, index + currentGene.length);
                const after = gene.symbol.substring(index + currentGene.length);

                div.innerHTML = `${before}<span class="match-highlight">${match}</span>${after}`;
                div.addEventListener('click', function() {
                    const afterCursor = fullVal.substring(cursorPos);
                    const nextCommaIndex = afterCursor.indexOf(',');

                    let newValue;
                    if (lastCommaIndex === -1) {
                        if (nextCommaIndex === -1) {
                            newValue = gene.symbol;
                        } else {
                            newValue = gene.symbol + afterCursor.substring(nextCommaIndex);
                        }
                    } else {
                        const beforeCurrentGene = fullVal.substring(0, lastCommaIndex + 1) + ' ';
                        if (nextCommaIndex === -1) {
                            newValue = beforeCurrentGene + gene.symbol;
                        } else {
                            newValue = beforeCurrentGene + gene.symbol + afterCursor.substring(nextCommaIndex);
                        }
                    }

                    input.value = newValue;

                    const newCursorPos = newValue.indexOf(gene.symbol) + gene.symbol.length;
                    input.setSelectionRange(newCursorPos, newCursorPos);

                    closeAllLists();
                    input.focus();
                });

                listDiv.appendChild(div);
            });
        }

        function handleKeyDown(event) {
            let list = document.getElementById('autocomplete-list');
            let items = list ? list.getElementsByTagName('div') : [];

            if (event.keyCode === 40) {
                currentFocus++;
                addActive(items);
                event.preventDefault();
            } else if (event.keyCode === 38) {
                currentFocus--;
                addActive(items);
                event.preventDefault();
            } else if (event.keyCode === 13) {
                event.preventDefault();
                if (currentFocus > -1 && items[currentFocus]) {
                    items[currentFocus].click();
                } else {
                    searchGenes();
                }
            } else if (event.keyCode === 27) {
                closeAllLists();
            }
        }

        function addActive(items) {
            if (!items || items.length === 0) return false;
            removeActive(items);
            if (currentFocus >= items.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = items.length - 1;
            items[currentFocus].classList.add('autocomplete-active');
            items[currentFocus].scrollIntoView({
                block: 'nearest'
            });
        }

        function removeActive(items) {
            for (let i = 0; i < items.length; i++) {
                items[i].classList.remove('autocomplete-active');
            }
        }

        function closeAllLists(elmnt) {
            /*close all autocomplete lists in the document,
            except the one passed as an argument:*/
            const x = document.getElementsByClassName("autocomplete-items");
            for (let i = 0; i < x.length; i++) {
                if (elmnt != x[i] &&
                    elmnt != document.getElementById("geneInput") &&
                    elmnt != document.getElementById("networkSearchInput") &&
                    elmnt != document.getElementById("heatmapSearch")) {
                    x[i].innerHTML = "";
                }
            }
            currentFocus = -1;
        }

        document.addEventListener('click', function(e) {
            closeAllLists(e.target);
        });

        function searchGenes() {
            const input = document.getElementById('geneInput').value.trim();
            closeAllLists();

            if (!input) {
                document.getElementById('results').innerHTML =
                    '<div class="error-message">Please enter at least one gene symbol to search.</div>';
                return;
            }

            if (geneData.length === 0) {
                document.getElementById('results').innerHTML =
                    '<div class="error-message">Data is still loading. Please wait a moment and try again.</div>';
                return;
            }

            const geneSymbols = input.split(',').map(g => g.trim()).filter(g => g);

            const resultsDiv = document.getElementById('results');
            let resultsHTML = '';
            let foundCount = 0;
            let notFoundGenes = [];
            let foundGenesList = [];

            geneSymbols.forEach(geneSymbol => {
                const gene = geneData.find(g => g.symbol.toLowerCase() === geneSymbol.toLowerCase());

                if (gene) {
                    foundCount++;
                    resultsHTML += generateGeneTable(gene);
                    foundGenesList.push(gene.symbol);
                } else {
                    notFoundGenes.push(geneSymbol);
                }
            });

            if (notFoundGenes.length > 0) {
                resultsHTML = `<div class="error-message">Gene(s) not found in database: <strong>${notFoundGenes.join(', ')}</strong><br>Please verify the gene symbols and try again.</div>` + resultsHTML;
            }

            if (foundCount === 0 && notFoundGenes.length > 0) {
                resultsHTML = '<div class="error-message">No matching genes found. Please check your gene symbols and try again.</div>';
            }

            resultsDiv.innerHTML = resultsHTML;

            // Draw networks for found genes
            foundGenesList.forEach(symbol => {
                drawNetwork(symbol);
            });

            // Show/hide export button
            lastSearchResults = foundGenesList;
            document.getElementById('exportSearchBtn').style.display = foundCount > 0 ? 'inline-flex' : 'none';

            // Update URL for sharing
            if (foundCount > 0) {
                const url = new URL(window.location);
                url.searchParams.set('gene', foundGenesList.join(','));
                window.history.replaceState({}, '', url);

                resultsDiv.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }

        function generateGeneTable(gene) {
            const isBookmarked = getBookmarks().includes(gene.symbol);
            const bookmarkIcon = isBookmarked ? '&#9733;' : '&#9734;';
            let tableHTML = `
                <div class="gene-result">
                    <div class="gene-header">
                        <div class="gene-name">
                            <button class="bookmark-btn" onclick="toggleBookmark('${gene.symbol}', this)" title="Bookmark this gene">${bookmarkIcon}</button>
                            ${gene.symbol}
                        </div>
                        <div class="gene-info">Gene Symbol: ${gene.symbol} | Developmental Stages: E10-P0</div>
                        <div class="external-links">
                            <a class="ext-link genecards" href="https://www.genecards.org/cgi-bin/carddisp.pl?gene=${gene.symbol}" target="_blank">GeneCards</a>
                            <a class="ext-link ncbi" href="https://www.ncbi.nlm.nih.gov/gene/?term=${gene.symbol}[sym]+AND+mouse[orgn]" target="_blank">NCBI Gene</a>
                            <a class="ext-link ensembl" href="https://www.ensembl.org/Mus_musculus/Gene/Summary?g=${gene.symbol}" target="_blank">Ensembl</a>
                            <a class="ext-link ucsc" href="https://genome.ucsc.edu/cgi-bin/hgTracks?db=mm10&position=${gene.symbol}" target="_blank">UCSC Browser</a>
                        </div>
                    </div>
                    <div class="gene-content">
                        <!-- Heatmap/Table View -->
                        <div class="table-container" style="margin-bottom: 20px;">
                            <table>
                                <thead>
                                    <tr>
                                        <th style="text-align: left; padding-left: 15px;">Gene</th>`;

            stages.forEach(stage => {
                tableHTML += `<th>${stage}</th>`;
            });

            // Add Adult Prediction Header
            tableHTML += `<th style="background-color: #1a4570; border-left: 3px solid white;" title="Predicted state based on developmental history">Adult (Pred)</th>`;

            tableHTML += `
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="gene-label">${gene.symbol}</td>`;

            stages.forEach(stage => {
                const state = gene.states[stage] || 'N/A';
                tableHTML += `<td class="${state}">${state}</td>`;
            });

            // Add Adult Prediction Cell
            const p0 = gene.states['P0'];
            const adult = predictAdult(p0);
            tableHTML += `<td class="${adult}" style="border-left: 3px solid #d4d4d4;">${adult}</td>`;

            tableHTML += `
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Network View -->
                        <div class="legend-title">Hierarchical Network Plot (Gene -> Stage -> Marks)</div>
                        <div id="network-${gene.symbol}" class="network-container"></div>
                    </div>
                </div>`;

            return tableHTML;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('geneInput').value = '';
            closeAllLists();
            document.getElementById('geneInput').focus();
        }

        // Toggle filter functions
        function initToggles() {
            const stageContainer = document.getElementById('stageToggles');
            const stateContainer = document.getElementById('stateToggles');

            stages.forEach(stage => {
                const chip = document.createElement('div');
                chip.className = 'toggle-chip active';
                chip.dataset.value = stage;
                chip.dataset.type = 'stage';
                chip.innerHTML = `<span class="toggle-dot"></span>${stage}`;
                chip.onclick = () => toggleChip(chip);
                stageContainer.appendChild(chip);
            });

            allStates.forEach(state => {
                const color = stateColors[state];
                const chip = document.createElement('div');
                chip.className = 'toggle-chip state-chip active';
                chip.dataset.value = state;
                chip.dataset.type = 'state';
                chip.style.setProperty('--state-color', color);
                chip.innerHTML = `<span class="toggle-dot" style="background:white;"></span>${state}`;
                chip.onclick = () => toggleChip(chip);
                stateContainer.appendChild(chip);
            });

            updateFilterSummary();
        }

        function toggleChip(chip) {
            chip.classList.toggle('active');
            const type = chip.dataset.type;
            const value = chip.dataset.value;

            if (type === 'stage') {
                if (chip.classList.contains('active')) {
                    activeStages.add(value);
                } else {
                    activeStages.delete(value);
                }
            } else {
                if (chip.classList.contains('active')) {
                    activeStatesFilter.add(value);
                } else {
                    activeStatesFilter.delete(value);
                }
            }
            updateFilterSummary();
        }

        function selectAllToggles(type) {
            const chips = document.querySelectorAll(`.toggle-chip[data-type="${type}"]`);
            chips.forEach(chip => {
                chip.classList.add('active');
                if (type === 'stage') activeStages.add(chip.dataset.value);
                else activeStatesFilter.add(chip.dataset.value);
            });
            updateFilterSummary();
        }

        function clearAllToggles() {
            document.querySelectorAll('.toggle-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            activeStages.clear();
            activeStatesFilter.clear();
            updateFilterSummary();
        }

        function updateFilterSummary() {
            const summary = document.getElementById('filterSummary');
            if (!summary) return;
            summary.textContent = `Stages: ${activeStages.size}/${stages.length} selected | States: ${activeStatesFilter.size}/${allStates.length} selected`;
        }

        function applyHeatmapFilters() {
            if (activeStages.size === 0 || activeStatesFilter.size === 0) {
                alert('Please select at least one stage and one state.');
                return;
            }

            // Filter genes: keep gene only if it has a matching state in ALL selected stages
            currentHeatmapData = geneData.filter(gene => {
                for (const stage of activeStages) {
                    const state = gene.states[stage];
                    if (!activeStatesFilter.has(state)) return false;
                }
                return true;
            });

            document.getElementById('startGene').value = 0;
            document.getElementById('endGene').value = Math.min(100, currentHeatmapData.length);

            const summary = document.getElementById('filterSummary');
            summary.textContent = `Stages: ${activeStages.size}/${stages.length} selected | States: ${activeStatesFilter.size}/${allStates.length} selected | Genes matched: ${currentHeatmapData.length.toLocaleString()}`;

            renderHeatmap();
        }

        // Heatmap functions
        let cellSize = 90;
        let highlightedGeneIndex = -1;

        function updateCellSize() {
            cellSize = parseInt(document.getElementById('cellSize').value);
            document.getElementById('cellSizeValue').textContent = cellSize + 'px';
            if (currentTab === 'heatmap') {
                renderHeatmap();
            }
        }

        function renderHeatmap() {
            if (currentHeatmapData.length === 0) return;

            const canvas = document.getElementById('heatmapCanvas');
            const ctx = canvas.getContext('2d');

            const startIdx = parseInt(document.getElementById('startGene').value) || 0;
            let endIdx = parseInt(document.getElementById('endGene').value) || 100;

            if (endIdx > currentHeatmapData.length) endIdx = currentHeatmapData.length;
            if (startIdx >= endIdx) {
                if (currentHeatmapData.length > 0) {
                    document.getElementById('startGene').value = 0;
                    document.getElementById('endGene').value = Math.min(100, currentHeatmapData.length);
                    renderHeatmap();
                    return;
                }
                return;
            }

            // Only show columns for active stages
            const visibleStages = stages.filter(s => activeStages.has(s));
            if (visibleStages.length === 0) return;

            const genesSubset = currentHeatmapData.slice(startIdx, endIdx);
            const numGenes = genesSubset.length;
            const numStages = visibleStages.length;

            // Set canvas size
            const labelWidth = 150;
            canvas.width = labelWidth + (numStages * cellSize);
            canvas.height = numGenes * cellSize + 30;

            // Clear canvas
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw headers
            ctx.font = 'bold 24px Arial';
            ctx.fillStyle = '#20558a';
            ctx.textAlign = 'center';
            visibleStages.forEach((stage, i) => {
                ctx.fillText(stage, labelWidth + (i * cellSize) + cellSize / 2, 20);
            });

            // Draw heatmap
            genesSubset.forEach((gene, geneIdx) => {
                const y = 30 + (geneIdx * cellSize);

                ctx.font = '28px Arial';
                ctx.fillStyle = '#333';
                ctx.textAlign = 'left';
                const label = gene.symbol.length > 18 ? gene.symbol.substring(0, 18) + '...' : gene.symbol;
                ctx.fillText(label, 5, y + cellSize / 2 + 4);

                // Draw cells only for visible stages
                visibleStages.forEach((stage, stageIdx) => {
                    const x = labelWidth + (stageIdx * cellSize);
                    const state = gene.states[stage];

                    ctx.fillStyle = stateColors[state] || '#cccccc';
                    ctx.fillRect(x, y, cellSize - 1, cellSize - 1);
                });
            });

            // Add tooltip on hover
            canvas.onmousemove = function(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                if (x > labelWidth && y > 30) {
                    const geneIdx = Math.floor((y - 30) / cellSize);
                    const stageIdx = Math.floor((x - labelWidth) / cellSize);

                    if (geneIdx >= 0 && geneIdx < numGenes && stageIdx >= 0 && stageIdx < numStages) {
                        const gene = genesSubset[geneIdx];
                        const stage = visibleStages[stageIdx];
                        const state = gene.states[stage];
                        canvas.title = `${gene.symbol} - ${stage}: ${state}`;
                    }
                }
            };
        }

        // Heatmap Autocomplete
        function handleHeatmapInput(event) {
            const input = event.target;
            const fullVal = input.value;
            const cursorPos = input.selectionStart;

            closeAllLists();

            const beforeCursor = fullVal.substring(0, cursorPos);
            const lastCommaIndex = beforeCursor.lastIndexOf(',');
            const currentGene = beforeCursor.substring(lastCommaIndex + 1).trim();

            if (!currentGene || currentGene.length < 1) {
                return false;
            }

            currentFocus = -1;

            const term = currentGene.toLowerCase();
            let matches = geneData.filter(gene =>
                gene.symbol.toLowerCase().includes(term)
            );

            // Sort: Exact -> StartsWith -> Alphabetical
            matches.sort((a, b) => {
                const aSym = a.symbol.toLowerCase();
                const bSym = b.symbol.toLowerCase();

                // 1. Exact match first
                if (aSym === term && bSym !== term) return -1;
                if (bSym === term && aSym !== term) return 1;

                // 2. Starts with second
                const aStart = aSym.startsWith(term);
                const bStart = bSym.startsWith(term);
                if (aStart && !bStart) return -1;
                if (!aStart && bStart) return 1;

                // 3. Alphabetical
                return aSym.localeCompare(bSym);
            });

            matches = matches.slice(0, 10);

            if (matches.length === 0) return;

            const listDiv = document.getElementById('heatmap-autocomplete-list');
            listDiv.innerHTML = '';

            matches.forEach(gene => {
                const div = document.createElement('div');

                const index = gene.symbol.toLowerCase().indexOf(currentGene.toLowerCase());
                const before = gene.symbol.substring(0, index);
                const match = gene.symbol.substring(index, index + currentGene.length);
                const after = gene.symbol.substring(index + currentGene.length);

                div.innerHTML = `${before}<span class="match-highlight">${match}</span>${after}`;
                div.addEventListener('click', function() {
                    const afterCursor = fullVal.substring(cursorPos);
                    const nextCommaIndex = afterCursor.indexOf(',');

                    let newValue;
                    if (lastCommaIndex === -1) {
                        if (nextCommaIndex === -1) {
                            newValue = gene.symbol;
                        } else {
                            newValue = gene.symbol + afterCursor.substring(nextCommaIndex);
                        }
                    } else {
                        const beforeCurrentGene = fullVal.substring(0, lastCommaIndex + 1) + ' ';
                        if (nextCommaIndex === -1) {
                            newValue = beforeCurrentGene + gene.symbol;
                        } else {
                            newValue = beforeCurrentGene + gene.symbol + afterCursor.substring(nextCommaIndex);
                        }
                    }

                    input.value = newValue;

                    const newCursorPos = newValue.indexOf(gene.symbol) + gene.symbol.length;
                    input.setSelectionRange(newCursorPos, newCursorPos);

                    closeAllLists();
                    input.focus();
                });

                listDiv.appendChild(div);
            });
        }

        function handleHeatmapKeyDown(event) {
            let list = document.getElementById('heatmap-autocomplete-list');
            let items = list ? list.getElementsByTagName('div') : [];

            if (event.keyCode === 40) { // Down
                currentFocus++;
                addActive(items);
            } else if (event.keyCode === 38) { // Up
                currentFocus--;
                addActive(items);
            } else if (event.keyCode === 13) { // Enter
                event.preventDefault();
                if (currentFocus > -1 && items[currentFocus]) {
                    items[currentFocus].click();
                } else {
                    searchInHeatmap();
                }
            } else if (event.keyCode === 27) { // Escape
                closeAllLists();
            }
        }

        function searchInHeatmap() {
            const input = document.getElementById('heatmapSearch').value.trim();

            // If empty, reset to full list
            if (!input) {
                currentHeatmapData = geneData;
                document.getElementById('startGene').value = 4000;
                document.getElementById('endGene').value = 4100;
                renderHeatmap();
                return;
            }

            const searchTerms = input.split(',').map(s => s.trim().toLowerCase()).filter(s => s);

            if (searchTerms.length === 0) return;

            // Filter geneData - EXACT MATCH to avoid pseudogenes (e.g., Tubb2a vs Tubb2a-ps2)
            const filtered = geneData.filter(gene => {
                const symbol = gene.symbol.toLowerCase();
                return searchTerms.some(term => symbol === term);
            });

            if (filtered.length === 0) {
                alert('No matching genes found.');
                return;
            }

            // Update current data and view
            currentHeatmapData = filtered;
            document.getElementById('startGene').value = 0;
            document.getElementById('endGene').value = filtered.length;

            renderHeatmap();
        }

        // Network Search Autocomplete
        function handleNetworkInput(event) {
            const input = event.target;
            const val = input.value;

            // Close existing list
            const listDiv = document.getElementById('network-autocomplete-list');
            listDiv.innerHTML = '';
            currentFocus = -1;

            if (!val) return false;

            const term = val.toLowerCase();
            let matches = geneData.filter(gene =>
                gene.symbol.toLowerCase().includes(term)
            );

            // Sort: Exact -> StartsWith -> Alphabetical
            matches.sort((a, b) => {
                const aSym = a.symbol.toLowerCase();
                const bSym = b.symbol.toLowerCase();

                // 1. Exact match first
                if (aSym === term && bSym !== term) return -1;
                if (bSym === term && aSym !== term) return 1;

                // 2. Starts with second
                const aStart = aSym.startsWith(term);
                const bStart = bSym.startsWith(term);
                if (aStart && !bStart) return -1;
                if (!aStart && bStart) return 1;

                // 3. Alphabetical
                return aSym.localeCompare(bSym);
            });

            matches = matches.slice(0, 10);

            matches.forEach(gene => {
                const div = document.createElement('div');
                const index = gene.symbol.toLowerCase().indexOf(val.toLowerCase());
                const before = gene.symbol.substring(0, index);
                const match = gene.symbol.substring(index, index + val.length);
                const after = gene.symbol.substring(index + val.length);

                div.innerHTML = `${before}<span class="match-highlight">${match}</span>${after}`;
                div.addEventListener('click', function() {
                    input.value = gene.symbol;
                    listDiv.innerHTML = '';
                    searchNetworkTab(); // Auto trigger search on selection
                });
                listDiv.appendChild(div);
            });
        }

        function handleNetworkKeyDown(event) {
            let list = document.getElementById('network-autocomplete-list');
            let items = list ? list.getElementsByTagName('div') : [];

            if (event.keyCode === 40) { // Down
                currentFocus++;
                addActive(items);
            } else if (event.keyCode === 38) { // Up
                currentFocus--;
                addActive(items);
            } else if (event.keyCode === 13) { // Enter
                event.preventDefault();
                if (currentFocus > -1 && items[currentFocus]) {
                    items[currentFocus].click();
                } else {
                    // If no suggestion selected, search with current text
                    // Close list first
                    list.innerHTML = '';
                    searchNetworkTab();
                }
            } else if (event.keyCode === 27) { // Escape
                list.innerHTML = '';
            }
        }

        // Network Visualization Logic
        function searchNetworkTab() {
            const input = document.getElementById('networkSearchInput').value.trim();
            if (!input) {
                alert("Please enter a gene symbol.");
                return;
            }
            // Clear container
            const container = document.getElementById('network-main-container');
            container.innerHTML = '';

            // Check if gene exists
            const gene = geneData.find(g => g.symbol.toLowerCase() === input.toLowerCase());
            if (!gene) {
                container.innerHTML = `<div style="padding:20px; text-align:center; color:red;">Gene '${input}' not found.</div>`;
                return;
            }

            // Create wrapper with download button
            const wrapperId = `network-wrapper-${gene.symbol}`;
            const plotId = `network-plot-${gene.symbol}`;

            container.innerHTML = `
                <div id="${wrapperId}" style="width:100%; display:flex; flex-direction:column; align-items:center;">
                    <button class="btn" style="margin-bottom:10px;" onclick="downloadNetwork('${plotId}', '${gene.symbol}')">üíæ Download Network (300 DPI PNG)</button>
                    <div id="${plotId}" style="width:100%; overflow:auto;"></div>
                </div>`;

            drawNetwork(gene.symbol, plotId);
        }

        function downloadNetwork(elementId, geneSymbol) {
            const container = document.getElementById(elementId);
            const svg = container.querySelector('svg');

            if (!svg) {
                alert("No network visualization found to download.");
                return;
            }

            const serializer = new XMLSerializer();
            let source = serializer.serializeToString(svg);

            // Add namespaces if missing
            if (!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)) {
                source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
            }
            if (!source.match(/^<svg[^>]+xmlns:xlink="http\:\/\/www\.w3\.org\/1999\/xlink"/)) {
                source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
            }

            // Prep for high res
            const scaleFactor = 4; // Approx 300 DPI (assuming 72-96 screen DPI)
            const width = parseInt(svg.getAttribute("width"));
            const height = parseInt(svg.getAttribute("height"));

            const canvas = document.createElement('canvas');
            canvas.width = width * scaleFactor;
            canvas.height = height * scaleFactor;
            const ctx = canvas.getContext('2d');

            // White background
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.scale(scaleFactor, scaleFactor);

            const img = new Image();
            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(source)));

            img.onload = function() {
                ctx.drawImage(img, 0, 0);
                const a = document.createElement('a');
                a.download = `${geneSymbol}_network_300dpi.png`;
                a.href = canvas.toDataURL('image/png');
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };
        }

        function drawNetwork(geneSymbol, specificContainerId = null) {
            const containerId = specificContainerId || `network-${geneSymbol}`;
            const container = document.getElementById(containerId);
            if (!container) return;

            // Clear previous svg if any
            container.innerHTML = '';

            // Get Data from window.geneDetails
            if (!window.geneDetails || !window.geneDetails[geneSymbol]) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">Detailed mark data not available for this gene.</div>';
                return;
            }

            // Get Gene State Info
            const geneObj = geneData.find(g => g.symbol.toLowerCase() === geneSymbol.toLowerCase());
            if (!geneObj) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">Gene state data not found.</div>';
                return;
            }

            const markData = window.geneDetails[geneSymbol]; // Array of 8 arrays

            // ---------------------------------------------------------
            // 1. Data Structure: Standard Hierarchy (Root -> Stages -> Marks)
            // ---------------------------------------------------------
            const rootData = {
                name: geneSymbol,
                type: "gene",
                children: stages.map((stage, idx) => {
                    let marks = markData[idx] || [];
                    marks.sort();

                    // Get state for this stage
                    const stageState = geneObj.states[stage] || 'N/A';

                    return {
                        name: stage,
                        type: "stage",
                        state: stageState, // Pass state to stage node too if needed
                        children: marks.map(mark => ({
                            name: mark,
                            type: "mark",
                            parentState: stageState // Pass state to mark node for coloring
                        }))
                    };
                })
            };

            // ---------------------------------------------------------
            // 2. Dynamic Sizing
            // ---------------------------------------------------------
            const root = d3.hierarchy(rootData);
            let leaves = root.leaves();
            const leafCount = leaves.length;
            const minLeafWidth = 110;
            const width = Math.max(container.clientWidth || 1000, leafCount * minLeafWidth);
            const height = 800;
            const marginTop = 60;
            const marginBottom = 60;
            const marginLeft = 40;
            const marginRight = 40;

            const svg = d3.select(`#${containerId}`)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", [0, 0, width, height])
                .style("background-color", "white")
                .style("font-family", "Arial, sans-serif");

            // ---------------------------------------------------------
            // 3. Layout
            // ---------------------------------------------------------
            const tree = d3.tree()
                .size([width - marginLeft - marginRight, height - marginTop - marginBottom])
                .separation((a, b) => (a.parent == b.parent ? 1.1 : 1.3));

            tree(root);

            const g = svg.append("g")
                .attr("transform", `translate(${marginLeft},${marginTop})`);

            // ---------------------------------------------------------
            // 4. Links
            // ---------------------------------------------------------
            g.selectAll(".link")
                .data(root.links())
                .join("path")
                .attr("class", "link")
                .attr("d", d3.linkVertical()
                    .x(d => d.x)
                    .y(d => d.y))
                .style("stroke", "#ccc")
                .style("stroke-width", "1.5px")
                .style("fill", "none");

            // ---------------------------------------------------------
            // 5. Nodes
            // ---------------------------------------------------------
            const node = g.selectAll(".node")
                .data(root.descendants())
                .join("g")
                .attr("class", d => "node" + (d.children ? " node--internal" : " node--leaf"))
                .attr("transform", d => `translate(${d.x},${d.y})`);

            node.each(function(d) {
                const n = d3.select(this);

                // --- GENE (ROOT) ---
                if (d.data.type === 'gene') {
                    n.append("rect")
                        .attr("x", -70)
                        .attr("y", -30)
                        .attr("width", 140)
                        .attr("height", 60)
                        .attr("rx", 10)
                        .attr("ry", 10)
                        .style("fill", "#e7f3ff")
                        .style("stroke", "#20558a")
                        .style("stroke-width", "3px");

                    n.append("text")
                        .attr("dy", "0.35em")
                        .attr("text-anchor", "middle")
                        .style("fill", "black")
                        .style("font-weight", "bold")
                        .style("font-size", "24px")
                        .text(d.data.name);

                    // --- STAGE (LEVEL 1) ---
                } else if (d.data.type === 'stage') {
                    // Color stage node based on state? User asked for marks, but maybe stage too?
                    // Let's keep stage node consistent (Pink) to distinguish levels, 
                    // OR we can color the rim. Let's keep it simple pink for now 
                    // to maintain hierarchy clarity, as marks will carry the color.
                    n.append("circle")
                        .attr("r", 25)
                        .style("fill", "#ffe6f2")
                        .style("stroke", "#e83e8c")
                        .style("stroke-width", "2px");

                    n.append("text")
                        .attr("dy", "0.35em")
                        .attr("text-anchor", "middle")
                        .style("fill", "black")
                        .style("font-weight", "bold")
                        .style("font-size", "14px")
                        .text(d.data.name);

                    // --- MARKS (LEAVES) ---
                } else {
                    const state = d.data.parentState;
                    const color = stateColors[state] || '#cccccc'; // Fallback gray

                    // Lighten the color for background fill (optional, or use solid)
                    // Let's use solid border and lighter fill, or solid fill with white text?
                    // User requested black text. So lighter fill is better.
                    // Function to lighten color or just use opacity.

                    n.append("rect")
                        .attr("x", -45)
                        .attr("y", -12)
                        .attr("width", 90)
                        .attr("height", 24)
                        .attr("rx", 5)
                        .style("fill", color) // Use the state color directly
                        .style("fill-opacity", "0.2") // Make it pastel/light
                        .style("stroke", color)
                        .style("stroke-width", "2px");

                    n.append("text")
                        .attr("dy", "0.35em")
                        .attr("text-anchor", "middle")
                        .style("fill", "black")
                        .style("font-weight", "bold")
                        .style("font-size", "12px")
                        .text(d.data.name);
                }
            });
        }

        // =====================================================
        // CSV EXPORT FUNCTIONS
        // =====================================================
        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function genesToCSV(geneList) {
            let csv = 'Gene,' + stages.join(',') + ',Adult_Predicted\n';
            geneList.forEach(symbol => {
                const gene = geneData.find(g => g.symbol === symbol);
                if (!gene) return;
                const row = [gene.symbol];
                stages.forEach(s => row.push(gene.states[s] || 'N/A'));
                row.push(predictAdult(gene.states['P0']));
                csv += row.join(',') + '\n';
            });
            return csv;
        }

        function exportSearchResults() {
            if (lastSearchResults.length === 0) return;
            const csv = genesToCSV(lastSearchResults);
            downloadCSV(csv, 'search_results.csv');
        }

        function exportHeatmapCSV() {
            if (currentHeatmapData.length === 0) return;
            const visibleStages = stages.filter(s => activeStages.has(s));
            let csv = 'Gene,' + visibleStages.join(',') + '\n';
            currentHeatmapData.forEach(gene => {
                const row = [gene.symbol];
                visibleStages.forEach(s => row.push(gene.states[s] || 'N/A'));
                csv += row.join(',') + '\n';
            });
            downloadCSV(csv, 'heatmap_filtered_data.csv');
        }

        // =====================================================
        // BOOKMARK FUNCTIONS
        // =====================================================
        function getBookmarks() {
            return JSON.parse(localStorage.getItem('geneBookmarks') || '[]');
        }

        function saveBookmarks(bookmarks) {
            localStorage.setItem('geneBookmarks', JSON.stringify(bookmarks));
            renderBookmarksBar();
        }

        function toggleBookmark(symbol, btn) {
            let bookmarks = getBookmarks();
            const idx = bookmarks.indexOf(symbol);
            if (idx === -1) {
                bookmarks.push(symbol);
                if (btn) btn.innerHTML = '&#9733;';
            } else {
                bookmarks.splice(idx, 1);
                if (btn) btn.innerHTML = '&#9734;';
            }
            saveBookmarks(bookmarks);
        }

        function renderBookmarksBar() {
            const bar = document.getElementById('bookmarksBar');
            const chips = document.getElementById('bookmarkChips');
            const bookmarks = getBookmarks();

            if (bookmarks.length === 0) {
                bar.style.display = 'none';
                return;
            }

            bar.style.display = 'block';
            chips.innerHTML = '';
            bookmarks.forEach(symbol => {
                const chip = document.createElement('span');
                chip.className = 'bookmark-chip';
                chip.innerHTML = `<span onclick="searchSingleGene('${symbol}')">${symbol}</span><span class="remove-bookmark" onclick="event.stopPropagation(); toggleBookmark('${symbol}', null)">&times;</span>`;
                chips.appendChild(chip);
            });
        }

        function searchSingleGene(symbol) {
            document.getElementById('geneInput').value = symbol;
            searchGenes();
        }

        function searchBookmarkedGenes() {
            const bookmarks = getBookmarks();
            if (bookmarks.length === 0) return;
            document.getElementById('geneInput').value = bookmarks.join(', ');
            searchGenes();
        }

        function exportBookmarks() {
            const bookmarks = getBookmarks();
            if (bookmarks.length === 0) return;
            const csv = genesToCSV(bookmarks);
            downloadCSV(csv, 'bookmarked_genes.csv');
        }

        function clearBookmarks() {
            localStorage.removeItem('geneBookmarks');
            renderBookmarksBar();
        }

        // =====================================================
        // STATE TRANSITION SEARCH
        // =====================================================
        function initTransitionDropdowns() {
            const fromStage = document.getElementById('transFromStage');
            const toStage = document.getElementById('transToStage');
            const fromState = document.getElementById('transFromState');
            const toState = document.getElementById('transToState');

            stages.forEach(s => {
                fromStage.innerHTML += `<option value="${s}">${s}</option>`;
                toStage.innerHTML += `<option value="${s}">${s}</option>`;
            });
            toStage.value = 'P0';

            allStates.forEach(s => {
                fromState.innerHTML += `<option value="${s}">${s}</option>`;
                toState.innerHTML += `<option value="${s}">${s}</option>`;
            });
        }

        function searchTransition() {
            const fromStage = document.getElementById('transFromStage').value;
            const toStage = document.getElementById('transToStage').value;
            const fromState = document.getElementById('transFromState').value;
            const toState = document.getElementById('transToState').value;

            const matches = geneData.filter(gene =>
                gene.states[fromStage] === fromState && gene.states[toStage] === toState
            );

            const resultDiv = document.getElementById('transitionResults');

            if (matches.length === 0) {
                resultDiv.innerHTML = '<span style="color:#dc3545;">No genes found matching this transition.</span>';
                return;
            }

            resultDiv.innerHTML = `<strong style="color:#28a745;">${matches.length.toLocaleString()} gene(s) found:</strong> ${fromState} (${fromStage}) &#8594; ${toState} (${toStage})`;

            // Show results in main results area
            const resultsDiv = document.getElementById('results');
            let html = '';
            const displayGenes = matches.slice(0, 50);
            if (matches.length > 50) {
                html += `<div class="data-info">Showing first 50 of ${matches.length} results. Use export to get all.</div>`;
            }
            displayGenes.forEach(gene => {
                html += generateGeneTable(gene);
            });
            resultsDiv.innerHTML = html;

            // Draw networks
            displayGenes.forEach(gene => drawNetwork(gene.symbol));

            // Store for export
            lastSearchResults = matches.map(g => g.symbol);
            document.getElementById('exportSearchBtn').style.display = 'inline-flex';

            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // =====================================================
        // STATISTICS TAB
        // =====================================================
        function initStatsTab() {
            // Populate comparison dropdowns
            const selA = document.getElementById('compareStageA');
            const selB = document.getElementById('compareStageB');
            stages.forEach(s => {
                selA.innerHTML += `<option value="${s}">${s}</option>`;
                selB.innerHTML += `<option value="${s}">${s}</option>`;
            });
            selA.value = 'E10';
            selB.value = 'P0';

            renderDistributionChart();
            renderComparisonMatrix();
        }

        function renderDistributionChart() {
            const container = document.getElementById('distributionChart');
            container.innerHTML = '';

            if (geneData.length === 0) return;

            // Calculate counts
            const data = [];
            stages.forEach(stage => {
                allStates.forEach(state => {
                    const count = geneData.filter(g => g.states[stage] === state).length;
                    data.push({ stage, state, count });
                });
            });

            const margin = { top: 30, right: 20, bottom: 60, left: 60 };
            const width = 900 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const svg = d3.select('#distributionChart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x0 = d3.scaleBand().domain(stages).range([0, width]).padding(0.2);
            const x1 = d3.scaleBand().domain(allStates).range([0, x0.bandwidth()]).padding(0.05);
            const y = d3.scaleLinear().domain([0, d3.max(data, d => d.count)]).nice().range([height, 0]);

            // X axis
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x0))
                .selectAll('text')
                .style('font-size', '12px')
                .style('font-weight', 'bold');

            // Y axis
            svg.append('g')
                .call(d3.axisLeft(y).ticks(8))
                .selectAll('text')
                .style('font-size', '11px');

            // Y axis label
            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', -50)
                .attr('x', -height / 2)
                .attr('text-anchor', 'middle')
                .style('font-size', '13px')
                .style('fill', '#333')
                .text('Number of Genes');

            // Bars
            const stageGroups = svg.selectAll('.stage-group')
                .data(stages)
                .join('g')
                .attr('transform', d => `translate(${x0(d)},0)`);

            stageGroups.selectAll('rect')
                .data(stage => allStates.map(state => {
                    const count = data.find(d => d.stage === stage && d.state === state).count;
                    return { state, count };
                }))
                .join('rect')
                .attr('x', d => x1(d.state))
                .attr('y', d => y(d.count))
                .attr('width', x1.bandwidth())
                .attr('height', d => height - y(d.count))
                .attr('fill', d => stateColors[d.state]);

            // Legend
            const legend = svg.selectAll('.legend')
                .data(allStates)
                .join('g')
                .attr('transform', (d, i) => `translate(${i * 130}, ${height + 35})`);

            legend.append('rect')
                .attr('width', 12)
                .attr('height', 12)
                .attr('fill', d => stateColors[d]);

            legend.append('text')
                .attr('x', 16)
                .attr('y', 10)
                .style('font-size', '10px')
                .style('fill', '#333')
                .text(d => d);
        }

        function renderComparisonMatrix() {
            const stageA = document.getElementById('compareStageA').value;
            const stageB = document.getElementById('compareStageB').value;
            const container = document.getElementById('comparisonMatrixContainer');

            if (geneData.length === 0) {
                container.innerHTML = '<p style="color:#666;">Data not loaded yet.</p>';
                return;
            }

            // Build transition counts
            const matrix = {};
            allStates.forEach(from => {
                matrix[from] = {};
                allStates.forEach(to => {
                    matrix[from][to] = 0;
                });
            });

            geneData.forEach(gene => {
                const from = gene.states[stageA];
                const to = gene.states[stageB];
                if (matrix[from] && matrix[from][to] !== undefined) {
                    matrix[from][to]++;
                }
            });

            // Find max for coloring
            let maxCount = 0;
            allStates.forEach(from => {
                allStates.forEach(to => {
                    if (matrix[from][to] > maxCount) maxCount = matrix[from][to];
                });
            });

            let html = `<p style="font-size:13px; color:#333; margin-bottom:8px;"><strong>${stageA}</strong> (rows) &#8594; <strong>${stageB}</strong> (columns)</p>`;
            html += '<table class="matrix-table"><thead><tr><th>' + stageA + ' \\ ' + stageB + '</th>';
            allStates.forEach(to => {
                html += `<th>${to}</th>`;
            });
            html += '<th>Total</th></tr></thead><tbody>';

            allStates.forEach(from => {
                html += `<tr><td class="row-header">${from}</td>`;
                let rowTotal = 0;
                allStates.forEach(to => {
                    const count = matrix[from][to];
                    rowTotal += count;
                    let cellClass = 'matrix-cell-zero';
                    if (count > 0) {
                        const ratio = count / maxCount;
                        if (ratio > 0.5) cellClass = 'matrix-cell-high';
                        else if (ratio > 0.15) cellClass = 'matrix-cell-med';
                        else cellClass = 'matrix-cell-low';
                    }
                    html += `<td class="${cellClass}">${count.toLocaleString()}</td>`;
                });
                html += `<td style="background:#e8e8e8; font-weight:bold;">${rowTotal.toLocaleString()}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';

            // Export button
            html += `<button class="export-btn" style="margin-top:10px;" onclick="exportComparisonMatrix()">Export Matrix CSV</button>`;

            container.innerHTML = html;
        }

        function exportComparisonMatrix() {
            const stageA = document.getElementById('compareStageA').value;
            const stageB = document.getElementById('compareStageB').value;

            let csv = stageA + '_to_' + stageB + ',' + allStates.join(',') + '\n';
            allStates.forEach(from => {
                const row = [from];
                allStates.forEach(to => {
                    const count = geneData.filter(g => g.states[stageA] === from && g.states[stageB] === to).length;
                    row.push(count);
                });
                csv += row.join(',') + '\n';
            });
            downloadCSV(csv, `transition_matrix_${stageA}_to_${stageB}.csv`);
        }

        // =====================================================
        // URL SHARING
        // =====================================================
        function copyShareLink() {
            const input = document.getElementById('geneInput').value.trim();
            if (!input) {
                alert('Enter a gene first, then click Share Link.');
                return;
            }
            const url = new URL(window.location);
            url.searchParams.set('gene', input);
            navigator.clipboard.writeText(url.toString()).then(() => {
                alert('Link copied to clipboard!');
            }).catch(() => {
                prompt('Copy this link:', url.toString());
            });
        }

        function checkURLParams() {
            const params = new URLSearchParams(window.location.search);
            const gene = params.get('gene');
            if (gene) {
                document.getElementById('geneInput').value = gene;
                switchTabDirect('search');
                setTimeout(() => searchGenes(), 500);
            }
        }

        function switchTabDirect(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(tabName)) btn.classList.add('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // Load data when page loads
        window.addEventListener('load', loadData);
    </script>
</body>

</html>